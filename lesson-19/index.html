<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Shape Adventure</title>
    <!-- Font Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            overflow: hidden;
            background: #a1c4fd;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* Playground Background */
        .sky-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, #4facfe 0%, #00f2fe 100%);
            z-index: -1;
        }

        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 25vh;
            background: #91e462;
            border-top: 10px solid #7ed348;
            z-index: -1;
        }

        .cloud {
            position: absolute;
            background: white;
            border-radius: 50px;
            opacity: 0.9;
            animation: float linear infinite;
        }

        @keyframes float {
            from { transform: translateX(-300px); }
            to { transform: translateX(110vw); }
        }

        canvas { display: block; position: absolute; top: 0; left: 0; }
        #fireworks-canvas { pointer-events: none; z-index: 60; }
        
        .game-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            z-index: 10;
        }
        .btn {
            pointer-events: auto;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }
        .btn:hover { transform: translateY(-5px) scale(1.05); }
        .btn:active { transform: scale(0.9); }
        
        .shape-option {
            background: white;
            border-radius: 30px;
            padding: 10px;
            box-shadow: 0 10px 0 #cbd5e0, 0 15px 30px rgba(0,0,0,0.1);
            border: 6px solid #fff;
            width: 160px;
            height: 85px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            color: #2d3748;
            text-align: center;
            font-size: 1.1rem;
        }
        .shape-option.correct { border-color: #48bb78; background: #f0fff4; color: #276749; box-shadow: 0 10px 0 #38a169; }
        .shape-option.wrong { border-color: #f56565; background: #fff5f5; color: #9b2c2c; box-shadow: 0 10px 0 #e53e3e; }
        
        @keyframes pop {
            0% { transform: scale(0); }
            80% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .pop-animation { animation: pop 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        #real-world-card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 50px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15);
            border: 8px solid #fff;
            text-align: center;
            max-width: 320px;
        }
        #real-world-object {
            font-size: 9rem;
            line-height: 1.1;
            filter: drop-shadow(0 10px 15px rgba(0,0,0,0.2));
        }

        #question-box {
            margin-top: 2vh;
            background: #fff;
            border-radius: 100px;
            padding: 12px 50px;
            border: 8px solid #3182ce;
            box-shadow: 0 10px 0 #2c5282, 0 15px 30px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <div class="sky-bg">
        <div class="cloud" style="width: 200px; height: 60px; top: 10%; left: -100px; animation-duration: 35s;"></div>
        <div class="cloud" style="width: 250px; height: 80px; top: 25%; left: -200px; animation-duration: 50s; animation-delay: 5s;"></div>
        <div class="ground"></div>
    </div>

    <div id="game-container"></div>
    <canvas id="fireworks-canvas"></canvas>

    <!-- Start Screen -->
    <div id="start-screen" class="fixed inset-0 z-50 flex items-center justify-center bg-blue-500 p-6 text-center">
        <div class="bg-white p-12 rounded-[60px] shadow-2xl max-w-md w-full pop-animation border-[15px] border-yellow-400">
            <div class="text-8xl mb-6">ü•≥‚öΩüé≤</div>
            <h1 class="text-4xl font-extrabold text-blue-600 mb-2">3D Shape Adventure</h1>
            <p class="text-xl text-gray-500 mb-10 font-medium tracking-wide">Fun English Learning!</p>
            <button onclick="startGame()" class="btn bg-orange-500 hover:bg-orange-600 text-white text-3xl font-black py-6 px-14 rounded-full shadow-[0_12px_0_#9c4221] active:shadow-none active:translate-y-2 uppercase tracking-tighter">Play!</button>
        </div>
    </div>

    <!-- Game UI -->
    <div class="game-ui">
        <!-- Header -->
        <div class="flex justify-between items-center pointer-events-none w-full">
            <div class="bg-yellow-400 p-4 px-10 rounded-full shadow-lg pointer-events-auto border-4 border-white">
                <span class="text-blue-800 font-black text-3xl tracking-tighter">‚≠ê <span id="score">0</span></span>
            </div>
            <div id="level-badge" class="bg-purple-600 p-4 px-10 rounded-full shadow-lg pointer-events-auto text-white font-black text-2xl border-4 border-white">
                LEVEL <span id="level-num">1</span>
            </div>
        </div>

        <!-- Question Area -->
        <div id="question-area" class="flex flex-col items-center pointer-events-none flex-grow">
            <div id="question-box" class="pointer-events-auto pop-animation">
                <h3 class="text-2xl md:text-3xl font-black text-blue-600 uppercase tracking-widest">What is this 3D shape?</h3>
            </div>
            
            <!-- Level 2 Object Card -->
            <div id="real-world-display" class="hidden pointer-events-none mt-16 flex flex-col items-center">
                <div id="real-world-card" class="pop-animation">
                    <div id="real-world-object">üé≤</div>
                    <div id="object-label" class="mt-4 text-2xl font-black text-indigo-500 uppercase tracking-tighter">A Dice!</div>
                </div>
            </div>
        </div>

        <!-- Options Container -->
        <div id="options-container" class="flex flex-wrap justify-center gap-6 w-full max-w-5xl mx-auto pb-16 pointer-events-auto">
            <!-- Options injected by JS -->
        </div>
    </div>

    <!-- Feedback Overlay -->
    <div id="feedback" class="fixed inset-0 pointer-events-none flex items-center justify-center z-40 hidden">
        <div id="feedback-content" class="text-[14rem] drop-shadow-2xl"></div>
    </div>

    <script>
        // --- SOUNDS ---
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playTone(freq, type, duration, vol=0.2) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(vol, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + duration);
        }
        const successSnd = () => { playTone(523, 'sine', 0.15); setTimeout(() => playTone(659, 'sine', 0.15), 100); setTimeout(() => playTone(783, 'sine', 0.4, 0.3), 200); };
        const failSnd = () => { playTone(220, 'triangle', 0.2); setTimeout(() => playTone(140, 'triangle', 0.4), 150); };

        // --- FILTERED SHAPE DATA (Optimized Level 2 Items) ---
        const shapes = [
            { id: 'cube', name: 'Cube', color: 0xFF5733, geometry: new THREE.BoxGeometry(2.5, 2.5, 2.5), objects: [{e:'üé≤', l:'Dice'}, {e:'üì¶', l:'Box'}] },
            { id: 'cuboid', name: 'Cuboid', color: 0x33FFD1, geometry: new THREE.BoxGeometry(3.8, 2.2, 2), objects: [{e:'üìï', l:'Closed Book'}, {e:'üßÉ', l:'Juice Box'}, {e:'üß±', l:'Brick'}] },
            { id: 'sphere', name: 'Sphere', color: 0x33FF57, geometry: new THREE.SphereGeometry(2, 32, 32), objects: [{e:'‚öΩ', l:'Soccer Ball'}, {e:'üèÄ', l:'Basketball'}, {e:'üçä', l:'Orange'}] },
            { id: 'cylinder', name: 'Cylinder', color: 0x3357FF, geometry: new THREE.CylinderGeometry(1.4, 1.4, 3.2, 32), objects: [{e:'ü•´', l:'Can'}, {e:'üîã', l:'Battery'}, {e:'ü•Å', l:'Drum'}] },
            { id: 'cone', name: 'Cone', color: 0xF333FF, geometry: new THREE.ConeGeometry(2, 3.5, 32), objects: [{e:'üì£', l:'Megaphone'}] },
            { id: 'pyramid', name: 'Pyramid', color: 0xFFF333, geometry: new THREE.ConeGeometry(2.2, 3.5, 4), objects: [{e:'üóª', l:'Great Pyramid'}, {e:'‚õ∞Ô∏è', l:'Step Pyramid'}] },
            { id: 'prism', name: 'Prism', color: 0xFF8C00, geometry: new THREE.CylinderGeometry(1.8, 1.8, 3.2, 3), objects: [{e:'üç∞', l:'Cake Slice'}, {e:'üßÄ', l:'Cheese'}] }
        ];

        let score = 0;
        let level = 1;
        let questionIndex = 0;
        let level1Shapes = [];
        let level2Shapes = [];
        let targetShape = null;
        let scene, camera, renderer, currentMesh;

        // --- FIREWORKS ---
        const fwCanvas = document.getElementById('fireworks-canvas');
        const fwCtx = fwCanvas.getContext('2d');
        let fireworks = [];

        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.speed = Math.random() * 7 + 3;
                this.angle = Math.random() * Math.PI * 2;
                this.friction = 0.96; this.gravity = 0.3;
                this.vx = Math.cos(this.angle) * this.speed;
                this.vy = Math.sin(this.angle) * this.speed;
                this.opacity = 1;
            }
            update() {
                this.vx *= this.friction; this.vy *= this.friction;
                this.vy += this.gravity;
                this.x += this.vx; this.y += this.vy;
                this.opacity -= 0.015;
            }
            draw() {
                fwCtx.globalAlpha = this.opacity;
                fwCtx.fillStyle = this.color;
                fwCtx.beginPath();
                fwCtx.arc(this.x, this.y, 4, 0, Math.PI * 2);
                fwCtx.fill();
            }
        }

        function createFirework(x, y) {
            const colors = ['#FFD700', '#FF1493', '#00BFFF', '#ADFF2F', '#FF4500', '#FFFFFF'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            for (let i = 0; i < 50; i++) fireworks.push(new Particle(x, y, color));
        }

        function animateFireworks() {
            fwCtx.clearRect(0, 0, fwCanvas.width, fwCanvas.height);
            fireworks = fireworks.filter(p => p.opacity > 0);
            fireworks.forEach(p => { p.update(); p.draw(); });
            requestAnimationFrame(animateFireworks);
        }

        // --- THREE JS ---
        function initThree() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('game-container').appendChild(renderer.domElement);
            scene.add(new THREE.AmbientLight(0xffffff, 1.2));
            const light = new THREE.DirectionalLight(0xffffff, 0.6);
            light.position.set(5, 10, 5);
            scene.add(light);
            camera.position.z = 8;
            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            if (currentMesh) {
                currentMesh.rotation.y += 0.02;
                currentMesh.rotation.x += 0.005;
            }
            renderer.render(scene, camera);
        }

        // --- GAMEPLAY ---
        function startGame() {
            audioCtx.resume();
            document.getElementById('start-screen').classList.add('hidden');
            fwCanvas.width = window.innerWidth;
            fwCanvas.height = window.innerHeight;
            animateFireworks();

            level1Shapes = [...shapes].sort(() => 0.5 - Math.random());
            level2Shapes = [...shapes].sort(() => 0.5 - Math.random());
            
            initThree();
            nextQuestion();
        }

        function nextQuestion() {
            if (level === 1 && questionIndex >= level1Shapes.length) {
                level = 2; questionIndex = 0;
            } 
            
            if (level === 2 && questionIndex >= level2Shapes.length) {
                showGameEnd();
                return;
            }

            document.getElementById('level-num').innerText = level;
            
            if (level === 1) {
                targetShape = level1Shapes[questionIndex];
                document.getElementById('real-world-display').classList.add('hidden');
                showMesh(targetShape);
            } else {
                targetShape = level2Shapes[questionIndex];
                if (currentMesh) scene.remove(currentMesh);
                document.getElementById('real-world-display').classList.remove('hidden');
                const randomObj = targetShape.objects[Math.floor(Math.random() * targetShape.objects.length)];
                document.getElementById('real-world-object').innerText = randomObj.e;
                document.getElementById('object-label').innerText = `A ${randomObj.l}!`;
            }

            generateOptions();
        }

        function showMesh(shapeData) {
            if (currentMesh) scene.remove(currentMesh);
            const material = new THREE.MeshPhongMaterial({ 
                color: shapeData.color, 
                shininess: 120,
                specular: 0xffffff 
            });
            currentMesh = new THREE.Mesh(shapeData.geometry, material);
            currentMesh.scale.set(0,0,0);
            scene.add(currentMesh);
            
            if (shapeData.id === 'pyramid' || shapeData.id === 'cone') currentMesh.position.y = -0.5;
            else currentMesh.position.y = 0;

            let s = 0;
            const anim = setInterval(() => {
                s += 0.1;
                currentMesh.scale.set(s,s,s);
                if (s >= 1) clearInterval(anim);
            }, 20);
        }

        function generateOptions() {
            const container = document.getElementById('options-container');
            container.innerHTML = '';
            
            let others = shapes.filter(s => s.id !== targetShape.id).sort(() => 0.5 - Math.random()).slice(0, 3);
            let options = [...others, targetShape].sort(() => 0.5 - Math.random());

            options.forEach(opt => {
                const div = document.createElement('div');
                div.className = 'shape-option btn pop-animation uppercase';
                div.innerText = opt.name;
                div.onclick = () => checkAnswer(opt.id, div);
                container.appendChild(div);
            });
        }

        function checkAnswer(selectedId, element) {
            if (selectedId === targetShape.id) {
                score += 10;
                document.getElementById('score').innerText = score;
                element.classList.add('correct');
                showFeedback('üåü');
                successSnd();
                
                const rect = element.getBoundingClientRect();
                createFirework(rect.left + rect.width/2, rect.top);

                setTimeout(() => {
                    questionIndex++;
                    nextQuestion();
                }, 1500);
            } else {
                element.classList.add('wrong');
                showFeedback('‚ùå');
                failSnd();
                setTimeout(() => element.classList.remove('wrong'), 800);
            }
        }

        function showFeedback(emoji) {
            const fb = document.getElementById('feedback');
            const content = document.getElementById('feedback-content');
            content.innerText = emoji;
            fb.classList.remove('hidden');
            setTimeout(() => fb.classList.add('hidden'), 1000);
        }

        function showGameEnd() {
            const fwInterval = setInterval(() => {
                createFirework(Math.random() * fwCanvas.width, Math.random() * fwCanvas.height);
            }, 400);

            const startScreen = document.getElementById('start-screen');
            startScreen.innerHTML = `
                <div class="bg-white p-12 rounded-[60px] shadow-2xl max-w-md w-full pop-animation relative z-[100] border-[15px] border-green-400">
                    <div class="text-9xl mb-6">üèÜ</div>
                    <h1 class="text-4xl font-extrabold text-blue-600 mb-2">Well Done!</h1>
                    <p class="text-xl text-gray-500 mb-6 font-bold uppercase tracking-widest">You know your shapes!</p>
                    <div class="bg-blue-50 p-8 rounded-[40px] mb-10 border-4 border-dashed border-blue-200">
                        <div class="text-lg text-blue-400 font-black uppercase mb-1">Total Score</div>
                        <div class="text-7xl font-black text-blue-600">${score}</div>
                    </div>
                    <button onclick="location.reload()" class="btn bg-orange-500 hover:bg-orange-600 text-white text-3xl font-black py-6 px-14 rounded-full shadow-[0_12px_0_#9c4221] active:shadow-none active:translate-y-2 uppercase tracking-tighter">Play Again!</button>
                </div>
            `;
            startScreen.classList.remove('hidden');
        }

        window.onresize = () => {
            if (camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                fwCanvas.width = window.innerWidth;
                fwCanvas.height = window.innerHeight;
            }
        };
    </script>
</body>
</html>
