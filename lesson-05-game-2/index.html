<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../assets/brand.css">
    <meta charset="UTF-8">
    <!-- CẬP NHẬT: Cho phép zoom (user-scalable=yes) và bỏ giới hạn maximum-scale -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Tens and Ones Game</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Tone.js for Audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    
    <!-- Canvas Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <!-- Google Font 'Nunito' -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@700;900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Nunito', sans-serif;
            background: linear-gradient(135deg, #FFD700 0%, #FF69B4 100%);
            /* CẬP NHẬT: Đổi từ 'none' sang 'manipulation' để cho phép Panning/Zooming nhưng vẫn tối ưu cho touch */
            touch-action: manipulation; 
            overflow: hidden;
            user-select: none;
            height: 100dvh; 
            width: 100vw;
        }
        
        #game-container {
            width: 100%;
            height: 100%;
            max-width: 900px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            background-color: #fcfcfc;
        }

        .brand-header {
            font-size: 1.25rem;
            color: #6b46c1;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            text-shadow: 1px 1px 0px rgba(0,0,0,0.1);
        }
        @media (min-width: 768px) {
            .brand-header { font-size: 1.5rem; }
        }

        /* -- Drop Zones -- */
        .tens-and-ones-frame {
            display: grid;
            grid-template-columns: 1fr 1fr;
            border: 4px solid #6b46c1;
            border-radius: 8px;
            background-color: #fefcbf;
            flex-grow: 1;
            min-height: 0;
            overflow: hidden;
            position: relative;
        }
        
        .dropzone {
            padding: 4px;
            overflow-y: auto;
            overflow-x: hidden;
            height: 100%;
            position: relative;
        }
        
        .dropzone-tens {
            border-right: 4px solid #6b46c1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            padding-bottom: 40px;
        }
        
        .dropzone-ones {
            display: flex;
            flex-wrap: wrap;
            align-content: flex-start;
            gap: 4px;
            justify-content: center;
            padding-bottom: 40px;
        }

        /* -- Unifix Cubes Styling -- */
        .cube {
            cursor: grab;
            border-radius: 4px;
            box-shadow: 1px 1px 3px rgba(0,0,0,0.2);
            border: 1px solid rgba(0,0,0,0.1);
            transition: transform 0.1s ease-out;
            position: relative;
            flex-shrink: 0;
        }
        
        .cube:active {
            cursor: grabbing;
            transform: scale(1.05);
            z-index: 50;
        }
        
        :root {
            --cube-size: 30px;
        }

        .one-cube {
            width: var(--cube-size); 
            height: var(--cube-size);
            background-color: #4299e1; 
            border-color: #2b6cb0;
        }
        
        .ten-rod {
            width: calc(var(--cube-size) * 10); 
            height: var(--cube-size);
            background-color: #e53e3e; 
            border-color: #c53030;
            display: flex;
            flex-direction: row;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        }
        
        .ten-rod-segment {
            width: var(--cube-size);
            height: 100%;
            border-right: 1px solid rgba(0,0,0,0.2);
        }
        .ten-rod-segment:last-child {
            border-right: none;
        }

        @media (max-width: 600px) {
            :root {
                --cube-size: 18px; 
            }
            .ten-rod {
                max-width: 95%; 
            }
        }

        /* -- Flashcard Deck -- */
        #flashcard-deck {
            width: 70px;
            height: 90px; 
            position: relative; 
            cursor: pointer;
            perspective: 1000px;
        }
        @media (min-width: 768px) {
            #flashcard-deck { width: 90px; height: 120px; }
        }

        .card-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transition: transform 0.6s;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 3px solid white;
        }
        .card-back {
            background: linear-gradient(135deg, #a78bfa 0%, #6d28d9 100%);
            color: white;
            font-size: 2rem; 
            transform: rotateY(0deg);
        }
        .card-front {
            background: white;
            color: #2d3748;
            font-size: 2.5rem; 
            font-weight: 900;
            transform: rotateY(180deg);
            border: 3px solid #6d28d9;
        }
        
        #flashcard-deck.is-flipped .card-back { transform: rotateY(-180deg); }
        #flashcard-deck.is-flipped .card-front { transform: rotateY(0deg); }
        
        /* -- Dragging Ghost -- */
        .drag-clone {
            position: fixed; 
            pointer-events: none;
            z-index: 9999;
            opacity: 0.9;
            transform: translate(-50%, -50%);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        /* Animations */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .shake { animation: shake 0.4s ease-in-out; }

        @keyframes bounce-in {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); }
        }
        .bounce-in { animation: bounce-in 0.3s ease-out; }

        @keyframes pulse-btn {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        button {
            transition: all 0.2s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.2);
        }
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Regroup Button */
        #regroup-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 20;
            animation: pulse-btn 1.5s infinite;
        }
        
        /* Car Game Styling */
        #car-canvas {
            background: #333;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            touch-action: none;
        }
    </style>
</head>
<body class="flex items-center justify-center p-0 md:p-4 bg-gray-100 h-screen w-screen overflow-hidden">
    <img src="../assets/logo-oodles-math.png" class="oodles-logo">
    <div id="game-container" class="w-full bg-white md:rounded-2xl p-3 md:p-6 relative flex flex-col h-full">
        
        <!-- Header -->
        <div class="flex justify-between items-center w-full mb-2 shrink-0">
            <div class="brand-header">Tens & Ones</div>
            <div id="score" class="text-lg md:text-2xl font-black text-purple-600 bg-purple-100 px-3 py-1 rounded-full">Score: 0</div>
        </div>
        
        <!-- Game Area Top -->
        <div class="flex flex-row items-stretch justify-between gap-2 mb-2 shrink-0 h-auto">
            
            <!-- Deck -->
            <div class="flex flex-col items-center justify-center bg-purple-50 p-2 rounded-lg border border-purple-100 min-w-[90px]">
                <div id="flashcard-deck" title="Click to draw a new number">
                    <div id="card-face-back" class="card-face card-back">?</div>
                    <div id="card-face-front" class="card-face card-front"></div>
                </div>
                <div class="text-xs md:text-sm font-bold text-gray-500 mt-1 text-center leading-tight">Draw<br>Card</div>
            </div>

            <!-- Cube Bank -->
            <div class="flex-grow flex items-center justify-around p-2 bg-indigo-50 rounded-lg border border-indigo-100 relative overflow-visible">
                
                <div class="flex flex-col items-center justify-center">
                    <div class="h-8 flex items-center mb-1">
                        <div id="source-ten-rod" class="cube ten-rod" data-type="ten"></div>
                    </div>
                    <p class="text-xs md:text-base font-bold text-gray-600">Ten Rod</p>
                </div>
                
                <div class="flex flex-col items-center justify-center ml-2">
                     <div class="h-8 flex items-center mb-1">
                        <div id="source-one-cube" class="cube one-cube" data-type="one"></div>
                    </div>
                    <p class="text-xs md:text-base font-bold text-gray-600">One</p>
                </div>
            </div>
        </div>

        <!-- Drop Zones -->
        <div class="w-full flex-grow flex flex-col relative overflow-hidden">
            <div class="tens-and-ones-frame shadow-inner">
                <!-- TENS COLUMN -->
                <div class="flex flex-col h-full overflow-hidden relative">
                    <div class="text-center text-sm md:text-xl font-bold text-red-600 p-1 md:p-2 border-b-2 border-purple-200 bg-white/50 shrink-0">TENS</div>
                    <div id="tens-column" class="dropzone dropzone-tens"></div>
                </div>
                
                <!-- ONES COLUMN -->
                <div class="flex flex-col h-full border-l-2 border-purple-200 overflow-hidden relative">
                    <div class="text-center text-sm md:text-xl font-bold text-blue-600 p-1 md:p-2 border-b-2 border-purple-200 bg-white/50 shrink-0">ONES</div>
                    <div id="ones-column" class="dropzone dropzone-ones"></div>
                    
                    <!-- Regroup Button (Initially Hidden) -->
                    <button id="regroup-btn" class="hidden px-3 py-1 bg-yellow-400 text-yellow-900 font-bold text-xs md:text-sm rounded-full shadow-lg border-2 border-yellow-200 hover:bg-yellow-300">
                        Bundle 10 ➡️
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Controls -->
        <div class="flex justify-center items-center gap-3 mt-3 shrink-0 pb-1 md:pb-0">
            <button id="reset-board-button" class="flex-1 px-4 py-3 bg-gray-200 text-gray-700 text-base md:text-lg font-bold rounded-xl hover:bg-gray-300 border-b-4 border-gray-300 active:border-b-0 active:translate-y-1">
                Clear
            </button>
            <button id="submit-button" class="flex-1 px-4 py-3 bg-green-500 text-white text-base md:text-lg font-bold rounded-xl hover:bg-green-600 border-b-4 border-green-700 active:border-b-0 active:translate-y-1 disabled:opacity-50 disabled:border-none disabled:active:translate-y-0">
                Check
            </button>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div id="feedback-modal" class="hidden absolute inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 backdrop-blur-sm">
        <div id="feedback-content" class="text-5xl md:text-7xl font-black text-white p-8 md:p-12 rounded-2xl shadow-2xl transform transition-all text-center">
            <!-- Content -->
        </div>
    </div>
    
    <!-- BONUS GAME MODAL (CAR DODGE) -->
    <div id="bonus-game-modal" class="hidden absolute inset-0 bg-gradient-to-b from-blue-900 to-slate-900 flex flex-col items-center justify-center z-50 p-2">
        <h2 class="text-3xl md:text-4xl font-black text-yellow-300 mb-2 drop-shadow-md text-center uppercase">Bonus Round!</h2>
        <p class="text-white text-sm md:text-lg mb-4 text-center max-w-md">Collect Fruits! Avoid Obstacles! <br><span class="text-yellow-300 font-bold">Time: 15s</span></p>
        
        <!-- Game Canvas Container -->
        <div class="relative shadow-2xl rounded-lg overflow-hidden border-4 border-slate-600">
            <canvas id="car-canvas" width="320" height="480" class="block bg-gray-800 cursor-crosshair"></canvas>
            
            <!-- Start Overlay -->
            <div id="car-game-overlay" class="absolute inset-0 flex items-center justify-center bg-black/60 z-10 cursor-pointer">
                <div class="text-center animate-pulse">
                    <p class="text-4xl text-white font-bold mb-2">TAP TO START</p>
                    <p class="text-sm text-gray-300">Drag to move</p>
                </div>
            </div>
            
            <!-- HUD -->
            <div class="absolute top-2 left-2 right-2 flex justify-between text-white font-bold text-sm">
                <div class="bg-black/50 px-3 py-1 rounded-full border border-white/20">Time: <span id="car-timer">15</span>s</div>
                <div class="bg-black/50 px-3 py-1 rounded-full border border-white/20 text-yellow-300">Bonus: <span id="car-score">0</span></div>
            </div>
        </div>

        <p id="car-game-result" class="text-3xl text-white font-bold mt-4 hidden text-center">
            <!-- Result -->
        </p>
    </div>
    
    <!-- Game Over Modal -->
    <div id="game-over-modal" class="hidden absolute inset-0 bg-gradient-to-br from-green-400 to-teal-500 flex flex-col items-center justify-center z-50 p-4 text-center">
        <div class="bg-white p-6 md:p-8 rounded-3xl shadow-2xl max-w-md w-full relative overflow-hidden">
            <div class="absolute inset-0 bg-yellow-50 opacity-50 z-0"></div>
            <div class="relative z-10">
                <h2 class="text-4xl md:text-5xl font-black text-teal-600 mb-2">Great Job!</h2>
                <p class="text-lg md:text-xl text-gray-600 mb-6">You've completed all the cards.</p>
                <div class="bg-yellow-100 rounded-xl p-4 mb-8 transform rotate-1 border-2 border-yellow-300">
                    <p class="text-sm text-yellow-700 font-bold uppercase tracking-wider">Final Score</p>
                    <p id="final-score" class="text-5xl md:text-6xl font-black text-yellow-500">0</p>
                </div>
                <button id="play-again-button" class="w-full py-3 md:py-4 bg-teal-500 text-white text-xl font-bold rounded-xl hover:bg-teal-600 shadow-lg border-b-4 border-teal-700 active:border-0 active:translate-y-1">
                    Play Again
                </button>
            </div>
        </div>
    </div>


    <script>
        // --- DOM Elements ---
        let gameContainer, scoreEl, cardDeckEl, cardBackEl, cardFrontEl, 
            submitButton, resetButton, feedbackModal, feedbackContent, 
            bonusGameModal, carCanvas, carGameOverlay,
            carTimerEl, carScoreEl, carGameResult, regroupBtn,
            gameOverModal, finalScoreEl, playAgainButton, sourceTenRod, 
            sourceOneCube, tensColumn, onesColumn;
        
        // --- Game State ---
        let score = 0;
        let currentNumber = 0;
        let cardDeck = [];
        let isChecking = false;
        let isDragging = false;
        let dragClone = null;
        let dragSourceType = ''; 
        let audioContextStarted = false;
        
        // --- Car Game State ---
        let carCtx;
        let carGameLoopId;
        let carGameState = {
            isPlaying: false,
            timeLeft: 15,
            bonusScore: 0,
            carX: 140,
            carY: 380,
            carWidth: 40,
            carHeight: 70,
            obstacles: [],
            fruits: [],
            lastObstacleTime: 0,
            lastFruitTime: 0,
            obstacleInterval: 800, 
            speed: 5
        };
        
        // --- Audio Synths ---
        let clickSynth, correctSynth, incorrectSynth, drawCardSynth, grabCubeSynth, dropCubeSynth, bonusSound, winSound, crashSound, coinSound, breakSound;
        
        async function initAudio() {
            if (audioContextStarted) return;
            
            await Tone.start();
            audioContextStarted = true;
            
            // Initialize Synths
            const vol = new Tone.Volume(-5).toDestination();

            correctSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'triangle' }, envelope: { attack: 0.02, decay: 0.1, sustain: 0.1, release: 1 } }).connect(vol);
            incorrectSynth = new Tone.PolySynth(Tone.Synth, { oscillator: { type: 'sawtooth' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.2 } }).connect(vol);
            drawCardSynth = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.2 } }).connect(vol);
            grabCubeSynth = new Tone.FMSynth({ harmonicity: 3, modulationIndex: 10, envelope: { attack: 0.01, decay: 0.1 }, oscillator: { type: 'sine' }, modulation: { type: 'square' } }).connect(vol);
            dropCubeSynth = new Tone.PluckSynth({ attackNoise: 0.5, dampening: 4000 }).connect(vol);
            bonusSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0.5, release: 0.8 } }).connect(vol);
            winSound = new Tone.PolySynth(Tone.Synth).connect(vol);
            crashSound = new Tone.NoiseSynth({ noise: { type: 'brown' }, envelope: { attack: 0.01, decay: 0.3, sustain: 0 } }).connect(vol);
            coinSound = new Tone.MembraneSynth({ pitchDecay: 0.01, octaves: 4, oscillator: { type: 'sine' } }).toDestination();
            breakSound = new Tone.MembraneSynth({ pitchDecay: 0.05, octaves: 4, oscillator: { type: 'square' } }).toDestination();
        }
        
        ['mousedown', 'touchstart'].forEach(evt => 
            document.body.addEventListener(evt, initAudio, { once: true })
        );

        // --- Game Logic ---
        
        function initGame() {
            gameContainer = document.getElementById('game-container');
            scoreEl = document.getElementById('score');
            cardDeckEl = document.getElementById('flashcard-deck');
            cardBackEl = document.getElementById('card-face-back');
            cardFrontEl = document.getElementById('card-face-front');
            submitButton = document.getElementById('submit-button');
            resetButton = document.getElementById('reset-board-button');
            feedbackModal = document.getElementById('feedback-modal');
            feedbackContent = document.getElementById('feedback-content');
            regroupBtn = document.getElementById('regroup-btn');
            
            // Bonus Game Elements
            bonusGameModal = document.getElementById('bonus-game-modal');
            carCanvas = document.getElementById('car-canvas');
            carGameOverlay = document.getElementById('car-game-overlay');
            carTimerEl = document.getElementById('car-timer');
            carScoreEl = document.getElementById('car-score');
            carGameResult = document.getElementById('car-game-result');
            
            gameOverModal = document.getElementById('game-over-modal');
            finalScoreEl = document.getElementById('final-score');
            playAgainButton = document.getElementById('play-again-button');
            sourceTenRod = document.getElementById('source-ten-rod'); 
            sourceOneCube = document.getElementById('source-one-cube');
            tensColumn = document.getElementById('tens-column');
            onesColumn = document.getElementById('ones-column');
            
            createTenRodSegments(sourceTenRod);

            score = 0;
            updateScore(); 
            shuffleDeck();
            drawCard();
            setupDragEvents(); 
            
            submitButton.onclick = handleSubmit;
            resetButton.onclick = resetBoard;
            cardDeckEl.onclick = drawCard;
            regroupBtn.onclick = handleRegroup;
            playAgainButton.onclick = () => {
                gameOverModal.classList.add('hidden');
                initGame();
            };

            // Setup Canvas interaction
            carCanvas.addEventListener('mousemove', moveCar);
            carCanvas.addEventListener('touchmove', moveCar, {passive: false});
            carGameOverlay.addEventListener('click', startCarGame);
            carGameOverlay.addEventListener('touchstart', startCarGame);

            gameOverModal.classList.add('hidden');
            bonusGameModal.classList.add('hidden');
            checkRegroupState();
        }

        function createTenRodSegments(element) {
            element.innerHTML = '';
            for(let i = 0; i < 10; i++) {
                const seg = document.createElement('div');
                seg.className = 'ten-rod-segment';
                element.appendChild(seg);
            }
        }

        function shuffleDeck() {
            // Numbers 11 to 20
            cardDeck = Array.from({ length: 10 }, (_, i) => i + 11);
            for (let i = cardDeck.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardDeck[i], cardDeck[j]] = [cardDeck[j], cardDeck[i]];
            }
        }

        function drawCard() {
            if (isChecking) return;
            
            if (cardDeck.length === 0) {
                showGameEnd();
                return;
            }
            
            cardDeckEl.classList.remove('is-flipped');
            submitButton.disabled = true;
            
            setTimeout(() => {
                currentNumber = cardDeck.pop();
                cardFrontEl.textContent = currentNumber;
                
                cardDeckEl.classList.add('is-flipped');
                if(drawCardSynth && audioContextStarted) drawCardSynth.triggerAttackRelease("C5", "8n");
                
                resetBoard();
                submitButton.disabled = false;
            }, 300);
        }
        
        function resetBoard() {
            tensColumn.innerHTML = '';
            onesColumn.innerHTML = '';
            checkRegroupState();
        }

        function updateScore() {
            scoreEl.textContent = `Score: ${score}`;
        }
        
        function handleSubmit() {
            if (isChecking || !currentNumber) return;
            
            const targetTens = Math.floor(currentNumber / 10);
            const targetOnes = currentNumber % 10;
            
            const placedTens = countTens();
            const placedOnes = countOnes();
            
            if (placedTens === targetTens && placedOnes === targetOnes) {
                handleCorrectAnswer();
            } else {
                handleIncorrectAnswer();
            }
        }

        function countTens() { return tensColumn.querySelectorAll('.ten-rod').length; }
        function countOnes() { return onesColumn.querySelectorAll('.one-cube').length; }

        function checkRegroupState() {
            // Show regroup button if 10 or more ones
            if (countOnes() >= 10) {
                regroupBtn.classList.remove('hidden');
            } else {
                regroupBtn.classList.add('hidden');
            }
        }

        function handleRegroup() {
            const ones = Array.from(onesColumn.querySelectorAll('.one-cube'));
            if (ones.length < 10) return;

            // Remove 10 ones
            for(let i=0; i<10; i++) {
                ones[i].remove();
            }

            // Add 1 ten
            placeCube('ten', tensColumn, false);
            
            if(bonusSound && audioContextStarted) bonusSound.triggerAttackRelease("E4", "8n");
            
            checkRegroupState();
        }

        function handleCorrectAnswer() {
            isChecking = true;
            if(correctSynth && audioContextStarted) {
                correctSynth.triggerAttackRelease(["C5", "E5", "G5", "C6"], "4n");
            }
            
            showFeedback("Correct!", "bg-green-500");
            
            setTimeout(() => {
                feedbackModal.classList.add('hidden');
                showBonusGame(); 
            }, 1200); 
        }

        function handleIncorrectAnswer() {
            isChecking = true;
            if(incorrectSynth && audioContextStarted) {
                incorrectSynth.triggerAttackRelease(["G3", "F3"], "8n");
            }
            
            gameContainer.classList.add('shake');
            showFeedback("Try Again!", "bg-red-500");
            
            setTimeout(() => {
                gameContainer.classList.remove('shake');
                feedbackModal.classList.add('hidden');
                isChecking = false;
            }, 1000);
        }

        function showFeedback(message, bgColor) {
            feedbackContent.textContent = message;
            feedbackContent.className = `text-4xl md:text-7xl font-black text-white p-8 md:p-12 rounded-2xl shadow-2xl bounce-in ${bgColor}`;
            feedbackModal.classList.remove('hidden');
        }
        
        // --- CAR DODGE GAME LOGIC ---

        function showBonusGame() {
            bonusGameModal.classList.remove('hidden');
            carGameOverlay.classList.remove('hidden');
            carGameResult.classList.add('hidden');
            
            carCtx = carCanvas.getContext('2d');
            
            // Reset
            carGameState.isPlaying = false;
            carGameState.timeLeft = 15;
            carGameState.bonusScore = 0;
            carGameState.obstacles = [];
            carGameState.fruits = [];
            carGameState.carX = carCanvas.width / 2 - 20;
            
            carTimerEl.textContent = carGameState.timeLeft;
            carScoreEl.textContent = "0";
            
            drawGameFrame();
        }

        function startCarGame(e) {
            if(carGameState.isPlaying) return;
            e.stopPropagation();
            e.preventDefault();
            
            carGameOverlay.classList.add('hidden');
            carGameState.isPlaying = true;
            carGameState.lastObstacleTime = Date.now();
            carGameState.lastFruitTime = Date.now();
            
            gameLoop();
            
            const timerInterval = setInterval(() => {
                if(!carGameState.isPlaying) {
                    clearInterval(timerInterval);
                    return;
                }
                carGameState.timeLeft--;
                carTimerEl.textContent = carGameState.timeLeft;
                
                if(carGameState.timeLeft <= 0) {
                    endCarGame(true);
                    clearInterval(timerInterval);
                }
            }, 1000);
        }

        function moveCar(e) {
            if(!carGameState.isPlaying) return;
            e.preventDefault();
            
            const rect = carCanvas.getBoundingClientRect();
            let clientX = e.clientX;
            
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
            }
            
            const x = clientX - rect.left;
            carGameState.carX = Math.max(0, Math.min(carCanvas.width - carGameState.carWidth, x - carGameState.carWidth/2));
        }

        function gameLoop() {
            if(!carGameState.isPlaying) return;
            
            updateCarGame();
            drawGameFrame();
            carGameLoopId = requestAnimationFrame(gameLoop);
        }

        function updateCarGame() {
            const now = Date.now();
            
            // Spawn Obstacles
            if (now - carGameState.lastObstacleTime > carGameState.obstacleInterval) {
                const obsWidth = 40 + Math.random() * 20;
                carGameState.obstacles.push({
                    x: Math.random() * (carCanvas.width - obsWidth),
                    y: -60,
                    width: obsWidth,
                    height: 40,
                    type: Math.random() > 0.5 ? 'rock' : 'cone'
                });
                carGameState.lastObstacleTime = now;
            }
            
            // Spawn Fruits
            if (now - carGameState.lastFruitTime > 1200) {
                carGameState.fruits.push({
                    x: Math.random() * (carCanvas.width - 30),
                    y: -40,
                    r: 15,
                    color: Math.random() > 0.5 ? '#ef4444' : '#fbbf24' // Red(Apple) or Yellow(Banana)
                });
                carGameState.lastFruitTime = now;
            }
            
            // Move & Collide Obstacles
            carGameState.obstacles.forEach((obs, index) => {
                obs.y += carGameState.speed;
                // Collision
                if (rectIntersect(carGameState.carX, carGameState.carY, carGameState.carWidth, carGameState.carHeight, obs.x, obs.y, obs.width, obs.height)) {
                    endCarGame(false);
                }
            });
            
            // Move & Collide Fruits
            carGameState.fruits.forEach((f, index) => {
                f.y += carGameState.speed;
                // Collision
                if (rectIntersect(carGameState.carX, carGameState.carY, carGameState.carWidth, carGameState.carHeight, f.x - f.r, f.y - f.r, f.r*2, f.r*2)) {
                    carGameState.bonusScore += 10;
                    carScoreEl.textContent = carGameState.bonusScore;
                    carGameState.fruits.splice(index, 1);
                    if(coinSound && audioContextStarted) coinSound.triggerAttackRelease("C6", "16n");
                }
            });
            
            // Cleanup
            carGameState.obstacles = carGameState.obstacles.filter(o => o.y < carCanvas.height);
            carGameState.fruits = carGameState.fruits.filter(f => f.y < carCanvas.height);
        }

        function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
            return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
        }

        function drawGameFrame() {
            // Road
            carCtx.fillStyle = '#4b5563'; 
            carCtx.fillRect(0, 0, carCanvas.width, carCanvas.height);
            
            // Road Markings
            carCtx.fillStyle = '#fbbf24'; // Yellow center lines
            const offset = Date.now() / 4 % 80;
            for(let y = -80; y < carCanvas.height; y+=80) {
                carCtx.fillRect(carCanvas.width/2 - 2, y + offset, 4, 40);
            }
            
            // Grass
            carCtx.fillStyle = '#22c55e';
            carCtx.fillRect(0, 0, 20, carCanvas.height);
            carCtx.fillRect(carCanvas.width - 20, 0, 20, carCanvas.height);

            // Draw Car
            const cx = carGameState.carX;
            const cy = carGameState.carY;
            
            // Shadow
            carCtx.fillStyle = 'rgba(0,0,0,0.3)';
            carCtx.beginPath();
            carCtx.ellipse(cx + 20, cy + 65, 18, 5, 0, 0, Math.PI*2);
            carCtx.fill();

            // Body
            carCtx.fillStyle = '#ef4444'; // Red Car
            carCtx.beginPath();
            carCtx.roundRect(cx, cy + 10, 40, 60, 8);
            carCtx.fill();
            
            // Roof
            carCtx.fillStyle = '#b91c1c';
            carCtx.fillRect(cx + 5, cy + 30, 30, 25);
            
            // Windshield
            carCtx.fillStyle = '#93c5fd';
            carCtx.fillRect(cx + 6, cy + 32, 28, 10);
            
            // Headlights
            carCtx.fillStyle = '#fef08a';
            carCtx.beginPath();
            carCtx.arc(cx + 8, cy + 12, 4, 0, Math.PI*2);
            carCtx.arc(cx + 32, cy + 12, 4, 0, Math.PI*2);
            carCtx.fill();

            // Draw Obstacles
            carGameState.obstacles.forEach(obs => {
                if (obs.type === 'rock') {
                    carCtx.fillStyle = '#78716c';
                    carCtx.beginPath();
                    carCtx.moveTo(obs.x + obs.width/2, obs.y);
                    carCtx.lineTo(obs.x + obs.width, obs.y + obs.height);
                    carCtx.lineTo(obs.x, obs.y + obs.height);
                    carCtx.fill();
                } else {
                    carCtx.fillStyle = '#f97316'; // Cone
                    carCtx.beginPath();
                    carCtx.moveTo(obs.x + obs.width/2, obs.y);
                    carCtx.lineTo(obs.x + obs.width, obs.y + obs.height);
                    carCtx.lineTo(obs.x, obs.y + obs.height);
                    carCtx.fill();
                }
            });
            
            // Draw Fruits
            carGameState.fruits.forEach(f => {
                carCtx.fillStyle = f.color;
                carCtx.beginPath();
                carCtx.arc(f.x, f.y, f.r, 0, Math.PI*2);
                carCtx.fill();
                // Stem
                carCtx.fillStyle = '#166534';
                carCtx.fillRect(f.x - 2, f.y - f.r - 4, 4, 6);
            });
        }

        function endCarGame(win) {
            carGameState.isPlaying = false;
            cancelAnimationFrame(carGameLoopId);
            
            if (win) {
                const totalBonus = 50 + carGameState.bonusScore;
                score += totalBonus;
                updateScore();
                carGameResult.innerHTML = `Success!<br><span class="text-yellow-300">+${totalBonus} Points</span>`;
                carGameResult.className = "text-4xl text-white font-black mt-4 animate-bounce drop-shadow-lg text-center";
                carGameResult.classList.remove('hidden');
                
                if(bonusSound && audioContextStarted) {
                    bonusSound.triggerAttackRelease("G4", "0.2");
                    setTimeout(() => bonusSound.triggerAttackRelease("C5", "0.4"), 200);
                }
            } else {
                carGameResult.textContent = "Crash! No Bonus.";
                carGameResult.className = "text-3xl text-red-400 font-bold mt-4 animate-pulse";
                carGameResult.classList.remove('hidden');
                
                if(crashSound && audioContextStarted) crashSound.triggerAttackRelease("0.5");
            }
            
            setTimeout(() => {
                bonusGameModal.classList.add('hidden');
                isChecking = false;
                drawCard(); 
            }, 3000);
        }

        // --- GAME OVER + CONFETTI ---
        
        function showGameEnd() {
            finalScoreEl.textContent = score;
            gameOverModal.classList.remove('hidden');
            
            if(winSound && audioContextStarted) {
                const now = Tone.now();
                winSound.triggerAttackRelease(["C4", "E4", "G4", "C5"], "2n", now);
            }

            launchConfetti();
        }

        function launchConfetti() {
            var duration = 4000;
            var end = Date.now() + duration;

            (function frame() {
                confetti({
                    particleCount: 5,
                    angle: 60,
                    spread: 55,
                    origin: { x: 0 },
                    colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00']
                });
                confetti({
                    particleCount: 5,
                    angle: 120,
                    spread: 55,
                    origin: { x: 1 },
                    colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00']
                });

                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        // --- Drag and Drop Logic ---
        
        function setupDragEvents() {
            [sourceTenRod, sourceOneCube].forEach(source => {
                source.addEventListener('mousedown', startDrag);
                source.addEventListener('touchstart', startDrag, { passive: false });
            });
            
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('touchmove', dragMove, { passive: false });
            
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }
        
        function startDrag(e) {
            if (isChecking) return;
            if (e.cancelable) e.preventDefault(); 
            
            const sourceEl = e.currentTarget;
            dragSourceType = sourceEl.dataset.type; 
            
            dragClone = sourceEl.cloneNode(true);
            dragClone.classList.add('drag-clone');
            dragClone.style.width = getComputedStyle(sourceEl).width;
            dragClone.style.height = getComputedStyle(sourceEl).height;

            document.body.appendChild(dragClone);
            isDragging = true;
            
            const pos = getEventPosition(e);
            updateClonePosition(pos.x, pos.y);
            
            if(grabCubeSynth && audioContextStarted) grabCubeSynth.triggerAttackRelease("C4", "32n"); 
        }
        
        function dragMove(e) {
            if (!isDragging) return;
            if (e.cancelable) e.preventDefault(); 
            const pos = getEventPosition(e);
            updateClonePosition(pos.x, pos.y);
        }
        
        function updateClonePosition(x, y) {
            if (!dragClone) return;
            dragClone.style.left = `${x}px`;
            dragClone.style.top = `${y}px`;
        }

        function endDrag(e) {
            if (!isDragging || !dragClone) return;
            
            isDragging = false;
            dragClone.style.display = 'none';
            const pos = getEventPosition(e);
            const dropTarget = document.elementFromPoint(pos.x, pos.y);
            
            document.body.removeChild(dragClone);
            dragClone = null;
            
            if (!dropTarget) return;

            const isTens = tensColumn.contains(dropTarget) || dropTarget === tensColumn;
            const isOnes = onesColumn.contains(dropTarget) || dropTarget === onesColumn;

            // Logic: Place Cube/Rod
            if (dragSourceType === 'ten') {
                if (isOnes) {
                    // SPECIAL: Break Ten into 10 ones
                    breakTenIntoOnes();
                } else if (isTens) {
                    placeCube('ten', tensColumn, true);
                }
            } else if (dragSourceType === 'one') {
                if (isOnes) {
                    placeCube('one', onesColumn, true);
                }
            }
        }
        
        function breakTenIntoOnes() {
            // Visual feedback sound
            if(breakSound && audioContextStarted) breakSound.triggerAttackRelease("C3", "16n");
            
            // Add 10 one cubes to Ones column
            for(let i=0; i<10; i++) {
                placeCube('one', onesColumn, false);
            }
            // Check if we need to show regroup button
            checkRegroupState();
        }

        function placeCube(type, targetCol, playSound) {
            let newCube;
            if (type === 'ten') {
                newCube = sourceTenRod.cloneNode(true);
                newCube.removeAttribute('id');
            } else {
                newCube = sourceOneCube.cloneNode(true);
                newCube.removeAttribute('id');
            }
            targetCol.appendChild(newCube);
            
            if (playSound && dropCubeSynth && audioContextStarted) {
                dropCubeSynth.triggerAttackRelease(type === 'ten' ? "E3" : "G4", "16n");
            }

            // Clicking removes it
            newCube.addEventListener('click', () => {
                if(isChecking) return;
                newCube.remove();
                if(dropCubeSynth && audioContextStarted) dropCubeSynth.triggerAttackRelease("C2", "32n");
                checkRegroupState();
            });
            
            checkRegroupState();
        }
        
        function getEventPosition(e) {
            if (e.touches && e.touches.length > 0) return { x: e.touches[0].clientX, y: e.touches[0].clientY };
            if (e.changedTouches && e.changedTouches.length > 0) return { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
            return { x: e.clientX, y: e.clientY };
        }
        
        document.addEventListener('DOMContentLoaded', initGame);

    </script>
</body>
</html>
